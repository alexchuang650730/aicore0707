name: Release - è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v4.5.0)'
        required: true
        type: string
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: true
        default: 'regression'
        type: choice
        options:
          - smoke
          - regression
          - full
      force_release:
        description: 'å¼ºåˆ¶å‘å¸ƒ (è·³è¿‡è´¨é‡é—¨ç¦)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # è´¨é‡é—¨ç¦æ£€æŸ¥
  quality-gate:
    name: è´¨é‡é—¨ç¦æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.gate-check.outputs.proceed }}
      test_level: ${{ steps.gate-check.outputs.test_level }}
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è´¨é‡é—¨ç¦æ£€æŸ¥
      id: gate-check
      run: |
        python -c "
        import sys
        import os
        sys.path.append('.')
        
        from core.components.release_trigger_mcp.release_trigger_engine import ReleaseTriggerEngine
        
        # åˆå§‹åŒ–å‘å¸ƒå¼•æ“
        engine = ReleaseTriggerEngine()
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        version = '${{ github.event.inputs.version || github.ref_name }}'
        test_level = '${{ github.event.inputs.test_level || \"regression\" }}'
        force = '${{ github.event.inputs.force_release }}' == 'true'
        
        print(f'æ£€æŸ¥ç‰ˆæœ¬: {version}')
        print(f'æµ‹è¯•çº§åˆ«: {test_level}')
        print(f'å¼ºåˆ¶å‘å¸ƒ: {force}')
        
        # åˆ›å»ºå‘å¸ƒä¿¡æ¯
        release_info = {
            'version': version,
            'branch': 'main',
            'manual_trigger': True,
            'force': force
        }
        
        # æ£€æŸ¥å‘å¸ƒæ¡ä»¶
        import asyncio
        async def check():
            if force:
                print('å¼ºåˆ¶å‘å¸ƒæ¨¡å¼ï¼Œè·³è¿‡æ¡ä»¶æ£€æŸ¥')
                return True
            return await engine._check_release_conditions(release_info)
        
        should_proceed = asyncio.run(check())
        
        print(f'::set-output name=proceed::{str(should_proceed).lower()}')
        print(f'::set-output name=test_level::{test_level}')
        
        if not should_proceed and not force:
            print('âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥')
            sys.exit(1)
        else:
            print('âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡')
        "

  # Test MCPé›†æˆæµ‹è¯•
  test-mcp-integration:
    name: Test MCPé›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.should_proceed == 'true'
    
    strategy:
      matrix:
        test-suite: [core, integration, ui, performance]
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-mock
    
    - name: å®‰è£…Node.jsä¾èµ–
      run: |
        npm install
    
    - name: è¿è¡ŒTest MCPé›†æˆæµ‹è¯•
      run: |
        python -c "
        import asyncio
        import sys
        import json
        sys.path.append('.')
        
        from core.components.release_trigger_mcp.test_mcp_integration import TestMCPIntegration
        
        async def run_tests():
            # åˆå§‹åŒ–Test MCP
            config = {
                'testing_framework': {},
                'test_runner_config': None
            }
            test_mcp = TestMCPIntegration(config)
            
            # åˆ›å»ºå‘å¸ƒä¿¡æ¯
            release_info = {
                'version': '${{ github.event.inputs.version || github.ref_name }}',
                'branch': 'main',
                'commit_hash': '${{ github.sha }}'
            }
            
            # è¿è¡Œæµ‹è¯•
            test_level = '${{ needs.quality-gate.outputs.test_level }}'
            results = await test_mcp.run_tests_for_release(release_info, test_level)
            
            # è¾“å‡ºç»“æœ
            print(f'æµ‹è¯•å¥—ä»¶: ${{ matrix.test-suite }}')
            print(f'æµ‹è¯•çº§åˆ«: {test_level}')
            print(f'æµ‹è¯•ç»“æœ: {json.dumps(results, indent=2, ensure_ascii=False)}')
            
            # æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡
            if not results.get('success', False):
                print('âŒ æµ‹è¯•å¤±è´¥')
                sys.exit(1)
            else:
                print('âœ… æµ‹è¯•é€šè¿‡')
        
        asyncio.run(run_tests())
        "
    
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.test-suite }}
        path: test_results/

  # Release Trigger Engineæµ‹è¯•
  release-trigger-test:
    name: Release Trigger Engineæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [quality-gate, test-mcp-integration]
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: æµ‹è¯•Release Trigger Engine
      run: |
        python -c "
        import asyncio
        import sys
        sys.path.append('.')
        
        from core.components.release_trigger_mcp.release_trigger_engine import ReleaseTriggerEngine
        
        async def test_engine():
            # åˆå§‹åŒ–å¼•æ“
            engine = ReleaseTriggerEngine()
            
            # è·å–çŠ¶æ€
            status = engine.get_status()
            print(f'å¼•æ“çŠ¶æ€: {status}')
            
            # æµ‹è¯•æ‰‹åŠ¨è§¦å‘å‘å¸ƒ
            version = '${{ github.event.inputs.version || github.ref_name }}'
            force = '${{ github.event.inputs.force_release }}' == 'true'
            
            result = await engine.trigger_manual_release(version, force)
            print(f'æ‰‹åŠ¨è§¦å‘ç»“æœ: {result}')
            
            if not result.get('success', False):
                print('âŒ Release Triggeræµ‹è¯•å¤±è´¥')
                sys.exit(1)
            else:
                print('âœ… Release Triggeræµ‹è¯•é€šè¿‡')
        
        asyncio.run(test_engine())
        "

  # æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [quality-gate, test-mcp-integration, release-trigger-test]
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        npm install
    
    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build/release
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp -r core/ build/release/
        cp -r deployment/ build/release/
        cp requirements.txt build/release/
        cp *.py build/release/
        
        # æ„å»ºå‰ç«¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "package.json" ]; then
          npm run build || echo "å‰ç«¯æ„å»ºè·³è¿‡"
        fi
        
        echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd build
        tar -czf aicore0707-${{ github.event.inputs.version || github.ref_name }}.tar.gz release/
        echo "ğŸ“¦ å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
    
    - name: éƒ¨ç½²åˆ°è®¾å¤‡ç›®å½•
      run: |
        # éƒ¨ç½²åˆ°Macè®¾å¤‡ç›®å½•
        mkdir -p deployment/devices/mac/${{ github.event.inputs.version || github.ref_name }}
        cp -r build/release/* deployment/devices/mac/${{ github.event.inputs.version || github.ref_name }}/
        
        echo "ğŸš€ éƒ¨ç½²åˆ°è®¾å¤‡ç›®å½•å®Œæˆ"
    
    - name: åˆ›å»ºGitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        release_name: aicore0707 ${{ github.event.inputs.version || github.ref_name }}
        body: |
          ## ğŸ‰ aicore0707 ${{ github.event.inputs.version || github.ref_name }} å‘å¸ƒ
          
          ### âœ¨ æ–°åŠŸèƒ½
          - ğŸ”„ Release Trigger MCPé›†æˆ
          - ğŸ§ª Test MCPèƒ½åŠ›æ•´åˆ
          - ğŸ“Š å¢å¼ºçš„æµ‹è¯•æ¡†æ¶
          - ğŸš€ è‡ªåŠ¨åŒ–CI/CDæµç¨‹
          
          ### ğŸ”§ æ”¹è¿›
          - æå‡æµ‹è¯•è¦†ç›–ç‡
          - ä¼˜åŒ–å‘å¸ƒæµç¨‹
          - å¢å¼ºé”™è¯¯å¤„ç†
          
          ### ğŸ“‹ æµ‹è¯•ä¿¡æ¯
          - æµ‹è¯•çº§åˆ«: ${{ needs.quality-gate.outputs.test_level }}
          - è´¨é‡é—¨ç¦: âœ… é€šè¿‡
          - Test MCPé›†æˆ: âœ… é€šè¿‡
          
          ### ğŸ“¦ éƒ¨ç½²ä¿¡æ¯
          - éƒ¨ç½²ç›®æ ‡: Macè®¾å¤‡
          - éƒ¨ç½²è·¯å¾„: `deployment/devices/mac/${{ github.event.inputs.version || github.ref_name }}/`
        draft: false
        prerelease: false
    
    - name: ä¸Šä¼ å‘å¸ƒåŒ…
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/aicore0707-${{ github.event.inputs.version || github.ref_name }}.tar.gz
        asset_name: aicore0707-${{ github.event.inputs.version || github.ref_name }}.tar.gz
        asset_content_type: application/gzip

  # å‘å¸ƒé€šçŸ¥
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: needs.build-and-deploy.result == 'success'
      run: |
        echo "ğŸ‰ å‘å¸ƒæˆåŠŸé€šçŸ¥"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"
        echo "çŠ¶æ€: âœ… æˆåŠŸ"
        echo "æ—¶é—´: $(date)"
    
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: needs.build-and-deploy.result == 'failure'
      run: |
        echo "âŒ å‘å¸ƒå¤±è´¥é€šçŸ¥"
        echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"
        echo "çŠ¶æ€: âŒ å¤±è´¥"
        echo "æ—¶é—´: $(date)"

