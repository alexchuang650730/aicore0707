name: ClaudEditor Release CI/CD

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ (v4.4.0, v4.5.0ç­‰)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v4.4.1)'
        required: true
        type: string
      platform:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        default: 'mac'
        type: choice
        options:
          - mac
          - windows
          - linux
          - all
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - regression
          - full
          - performance

env:
  CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # é˜¶æ®µ1: çŽ¯å¢ƒå‡†å¤‡å’Œä»£ç æ£€æŸ¥
  prepare:
    name: å‡†å¤‡çŽ¯å¢ƒå’Œä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      platform: ${{ steps.extract-platform.outputs.platform }}
      test_level: ${{ steps.extract-test-level.outputs.test_level }}
      should_deploy: ${{ steps.quality-gate.outputs.should_deploy }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²
      
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'claudeditor/claudeditor-ui/package-lock.json'
      
      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ å‘å¸ƒç‰ˆæœ¬: $VERSION"
      
      - name: æå–å¹³å°ä¿¡æ¯
        id: extract-platform
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PLATFORM="${{ github.event.inputs.platform }}"
          else
            PLATFORM="mac"  # é»˜è®¤å¹³å°
          fi
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "ðŸ–¥ï¸ ç›®æ ‡å¹³å°: $PLATFORM"
      
      - name: æå–æµ‹è¯•çº§åˆ«
        id: extract-test-level
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TEST_LEVEL="${{ github.event.inputs.test_level }}"
          else
            # æ ¹æ®ç‰ˆæœ¬å˜åŒ–è‡ªåŠ¨ç¡®å®šæµ‹è¯•çº§åˆ«
            VERSION="${{ steps.extract-version.outputs.version }}"
            if [[ $VERSION =~ v[0-9]+\.[0-9]+\.[1-9][0-9]*$ ]]; then
              TEST_LEVEL="smoke"  # patchç‰ˆæœ¬
            elif [[ $VERSION =~ v[0-9]+\.[1-9][0-9]*\.0$ ]]; then
              TEST_LEVEL="regression"  # minorç‰ˆæœ¬
            else
              TEST_LEVEL="full"  # majorç‰ˆæœ¬
            fi
          fi
          echo "test_level=$TEST_LEVEL" >> $GITHUB_OUTPUT
          echo "ðŸ§ª æµ‹è¯•çº§åˆ«: $TEST_LEVEL"
      
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pytest playwright bandit coverage
      
      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          
          # å®‰å…¨æ‰«æ
          bandit -r core/ -f json -o bandit-report.json || true
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "core/components/test_mcp/__init__.py" ]; then
            echo "âŒ test_mcpç»„ä»¶æœªæ‰¾åˆ°"
            exit 1
          fi
          
          if [ ! -f "core/components/release_trigger_mcp/__init__.py" ]; then
            echo "âŒ release_trigger_mcpç»„ä»¶æœªæ‰¾åˆ°"
            exit 1
          fi
          
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
      
      - name: è´¨é‡é—¨ç¦é¢„æ£€æŸ¥
        id: quality-gate
        run: |
          echo "ðŸšª æ‰§è¡Œè´¨é‡é—¨ç¦é¢„æ£€æŸ¥..."
          
          # æ£€æŸ¥ç‰ˆæœ¬æ ¼å¼
          VERSION="${{ steps.extract-version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®: $VERSION"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # æ£€æŸ¥å¿…è¦çš„secrets
          if [ -z "${{ secrets.CLAUDE_API_KEY }}" ]; then
            echo "âŒ CLAUDE_API_KEYæœªé…ç½®"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… è´¨é‡é—¨ç¦é¢„æ£€æŸ¥é€šè¿‡"
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # é˜¶æ®µ2: è‡ªåŠ¨åŒ–æµ‹è¯• (test_mcp)
  test:
    name: è‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ${{ matrix.os }}
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true'
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: windows
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pytest playwright bandit coverage psutil
          
          # å®‰è£…Playwrightæµè§ˆå™¨
          playwright install
      
      - name: æž„å»ºClaudEditor UI
        run: |
          cd claudeditor/claudeditor-ui
          npm ci
          npm run build
      
      - name: è¿è¡Œtest_mcpæµ‹è¯•å¥—ä»¶
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ðŸ§ª è¿è¡Œ ${{ matrix.platform }} å¹³å°æµ‹è¯•..."
          
          # åˆ›å»ºæµ‹è¯•é…ç½®
          cat > test_config.json << EOF
          {
            "release_info": {
              "version": "${{ needs.prepare.outputs.version }}",
              "platform": "${{ matrix.platform }}",
              "test_level": "${{ needs.prepare.outputs.test_level }}"
            }
          }
          EOF
          
          # è¿è¡Œæµ‹è¯•
          python -c "
          import asyncio
          import json
          import sys
          sys.path.append('core/components')
          
          from test_mcp import TestMCPEngine
          
          async def run_tests():
              with open('test_config.json', 'r') as f:
                  config = json.load(f)
              
              engine = TestMCPEngine()
              results = await engine.run_release_testing(config['release_info'])
              
              # ä¿å­˜æµ‹è¯•ç»“æžœ
              with open('test_results_${{ matrix.platform }}.json', 'w') as f:
                  json.dump(results, f, indent=2, default=str)
              
              # æ£€æŸ¥æµ‹è¯•ç»“æžœ
              if not results['quality_gate']['passed']:
                  print('âŒ è´¨é‡é—¨ç¦å¤±è´¥')
                  print(f'é€šè¿‡çŽ‡: {results[\"quality_gate\"][\"pass_rate\"]:.1f}%')
                  print(f'å»ºè®®: {results[\"quality_gate\"][\"recommendation\"]}')
                  sys.exit(1)
              else:
                  print('âœ… è´¨é‡é—¨ç¦é€šè¿‡')
                  print(f'é€šè¿‡çŽ‡: {results[\"quality_gate\"][\"pass_rate\"]:.1f}%')
          
          asyncio.run(run_tests())
          "
      
      - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.platform }}
          path: test_results_*.json
          retention-days: 30
      
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.platform }}
          path: core/components/test_mcp/reports/
          retention-days: 30

  # é˜¶æ®µ3: æž„å»ºå‘å¸ƒåŒ…
  build:
    name: æž„å»ºå‘å¸ƒåŒ…
    runs-on: ${{ matrix.os }}
    needs: [prepare, test]
    if: needs.prepare.outputs.should_deploy == 'true'
    
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            artifact_name: ClaudEditor-Mac
          - os: ubuntu-latest
            platform: linux
            artifact_name: ClaudEditor-Linux
          - os: windows-latest
            platform: windows
            artifact_name: ClaudEditor-Windows
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: æž„å»ºClaudEditor UI
        run: |
          cd claudeditor/claudeditor-ui
          npm ci
          npm run build
      
      - name: æž„å»ºå¹³å°ç‰¹å®šåŒ…
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PLATFORM="${{ matrix.platform }}"
          
          echo "ðŸ”¨ æž„å»º $PLATFORM å¹³å°åŒ…..."
          
          # åˆ›å»ºæž„å»ºç›®å½•
          mkdir -p build/$PLATFORM
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
          cp -r core/ build/$PLATFORM/
          cp -r claudeditor/ build/$PLATFORM/
          cp -r deployment/ build/$PLATFORM/
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > build/$PLATFORM/VERSION << EOF
          {
            "version": "$VERSION",
            "platform": "$PLATFORM",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}"
          }
          EOF
          
          # å¹³å°ç‰¹å®šå¤„ç†
          if [ "$PLATFORM" = "mac" ]; then
            echo "ðŸŽ å¤„ç†Macå¹³å°ç‰¹å®šæ–‡ä»¶..."
            # å¤åˆ¶Macæµ‹è¯•çŽ¯å¢ƒ
            if [ -d "deployment/devices/mac/v4.4.0/mac_test_environment" ]; then
              cp -r deployment/devices/mac/v4.4.0/mac_test_environment build/$PLATFORM/
            fi
          fi
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd build
          tar -czf ${{ matrix.artifact_name }}-$VERSION.tar.gz $PLATFORM/
          
          echo "âœ… æž„å»ºå®Œæˆ: ${{ matrix.artifact_name }}-$VERSION.tar.gz"
      
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build/${{ matrix.artifact_name }}-*.tar.gz
          retention-days: 90

  # é˜¶æ®µ4: éƒ¨ç½²å‘å¸ƒ
  deploy:
    name: éƒ¨ç½²å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [prepare, test, build]
    if: needs.prepare.outputs.should_deploy == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: åˆ›å»ºGitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "ðŸš€ åˆ›å»ºGitHub Release: $VERSION"
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
          # ClaudEditor $VERSION å‘å¸ƒ
          
          ## ðŸŽ‰ æ–°åŠŸèƒ½
          - åŸºäºŽag-uiåè®®çš„ä¸‰æ å¼ç•Œé¢è®¾è®¡
          - å®Œæ•´çš„PowerAutomation AICoreé›†æˆ
          - MemoryOSå’ŒCollaboration MCPæ”¯æŒ
          - å¢žå¼ºçš„Claude + GeminiåŒæ¨¡åž‹AIåŠ©æ‰‹
          
          ## ðŸ§ª æµ‹è¯•ç»“æžœ
          - æ‰€æœ‰å¹³å°æµ‹è¯•é€šè¿‡
          - è´¨é‡é—¨ç¦éªŒè¯é€šè¿‡
          - æ€§èƒ½åŸºå‡†è¾¾æ ‡
          
          ## ðŸ“¦ ä¸‹è½½
          é€‰æ‹©é€‚åˆæ‚¨å¹³å°çš„å®‰è£…åŒ…ï¼š
          - **Mac**: ClaudEditor-Mac-$VERSION.tar.gz
          - **Linux**: ClaudEditor-Linux-$VERSION.tar.gz  
          - **Windows**: ClaudEditor-Windows-$VERSION.tar.gz
          
          ## ðŸ”§ å®‰è£…è¯´æ˜Ž
          è¯¦ç»†å®‰è£…è¯´æ˜Žè¯·å‚è€ƒ [README.md](https://github.com/alexchuang650730/aicore0707/blob/main/deployment/devices/mac/v4.4.0/README.md)
          EOF
          
          # åˆ›å»ºrelease
          gh release create $VERSION \
            --title "ClaudEditor $VERSION" \
            --notes-file release_notes.md \
            --draft=false \
            --prerelease=false
          
          # ä¸Šä¼ æž„å»ºäº§ç‰©
          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              for file in "$artifact_dir"*.tar.gz; do
                if [ -f "$file" ]; then
                  echo "ðŸ“¤ ä¸Šä¼ : $(basename "$file")"
                  gh release upload $VERSION "$file"
                fi
              done
            fi
          done
          
          echo "âœ… GitHub Releaseåˆ›å»ºå®Œæˆ"
      
      - name: æ›´æ–°éƒ¨ç½²çŠ¶æ€
        run: |
          echo "ðŸ“Š æ›´æ–°éƒ¨ç½²çŠ¶æ€..."
          
          # åˆ›å»ºéƒ¨ç½²æŠ¥å‘Š
          cat > deployment_report.json << EOF
          {
            "version": "${{ needs.prepare.outputs.version }}",
            "platform": "${{ needs.prepare.outputs.platform }}",
            "test_level": "${{ needs.prepare.outputs.test_level }}",
            "deployment_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "success",
            "github_release": "https://github.com/alexchuang650730/aicore0707/releases/tag/${{ needs.prepare.outputs.version }}",
            "artifacts": [
              "ClaudEditor-Mac-${{ needs.prepare.outputs.version }}.tar.gz",
              "ClaudEditor-Linux-${{ needs.prepare.outputs.version }}.tar.gz",
              "ClaudEditor-Windows-${{ needs.prepare.outputs.version }}.tar.gz"
            ]
          }
          EOF
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ðŸ”— Releaseé“¾æŽ¥: https://github.com/alexchuang650730/aicore0707/releases/tag/${{ needs.prepare.outputs.version }}"

  # é˜¶æ®µ5: é€šçŸ¥å’Œæ¸…ç†
  notify:
    name: é€šçŸ¥å’Œæ¸…ç†
    runs-on: ubuntu-latest
    needs: [prepare, test, build, deploy]
    if: always()
    
    steps:
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.deploy.result == 'success'
        run: |
          echo "ðŸŽ‰ ClaudEditor ${{ needs.prepare.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "ðŸ“¦ æ‰€æœ‰å¹³å°æž„å»ºå®Œæˆ"
          echo "ðŸ§ª æµ‹è¯•å…¨éƒ¨é€šè¿‡"
          echo "ðŸš€ GitHub Releaseå·²åˆ›å»º"
          echo "ðŸ”— ä¸‹è½½åœ°å€: https://github.com/alexchuang650730/aicore0707/releases/tag/${{ needs.prepare.outputs.version }}"
      
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: needs.deploy.result != 'success'
        run: |
          echo "âŒ ClaudEditor ${{ needs.prepare.outputs.version }} å‘å¸ƒå¤±è´¥ï¼"
          echo "ðŸ” è¯·æ£€æŸ¥æµ‹è¯•ç»“æžœå’Œæž„å»ºæ—¥å¿—"
          echo "ðŸ“‹ å¤±è´¥é˜¶æ®µ:"
          echo "  - å‡†å¤‡: ${{ needs.prepare.result }}"
          echo "  - æµ‹è¯•: ${{ needs.test.result }}"
          echo "  - æž„å»º: ${{ needs.build.result }}"
          echo "  - éƒ¨ç½²: ${{ needs.deploy.result }}"

